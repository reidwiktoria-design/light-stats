<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<title>S32 Monitor | Live</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root {
    --page-max: 1000px;
    --bg-body: #eef2f9;
    --bg-card: #FFFFFF;
    --accent: #254EDB; 
    --color-on: #8DAA91;   
    --color-off: #E07A5F;
    --color-future: #e8ecef; 
    --color-neutral: #94a3b8; 
    --color-row-on: #7E9C82; 
    --color-row-off: #CC6A50;
    --text-main: #111111;
    --text-muted: #888888;
    --border-subtle: rgba(0,0,0,0.05);
    --shadow-card: 0 4px 12px rgba(0,0,0,0.03);
    --radius-l: 24px;
    --radius-m: 16px;
    --attack-bg: #ffebee;
    --attack-text: #c62828;
    --sched-safe: #a3cfbb; 
    --sched-danger: #f87171; 
    --tooltip-bg: var(--accent);
    --tooltip-text: #fff;
    --z-tooltip: 5000;
    --z-nav: 4000;
    --z-drawer: 3000;
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg-body: #000000;
        --bg-card: #1c1c1e;
        --accent: #58a6ff; 
        --color-on: #3fb950;   
        --color-off: #f85149;
        --color-future: #2c2c2e; 
        --color-neutral: #8b949e; 
        --color-row-on: #238636; 
        --color-row-off: #da3633;
        --text-main: #f0f6fc;
        --text-muted: #8b949e;
        --border-subtle: rgba(255,255,255,0.1);
        --shadow-card: 0 4px 12px rgba(0,0,0,0.5);
        --attack-bg: #3c1618;
        --attack-text: #ff7b72;
        --sched-safe: #238636;
        --sched-danger: #da3633;
        --tooltip-bg: #2d333b;
        --tooltip-text: #f0f6fc;
    }
}

html {
    background-color: var(--bg-body); 
    height: 100%;
    -webkit-font-smoothing: antialiased;
}

@media (prefers-color-scheme: light) {
    html { background-image: radial-gradient(circle at 50% 0%, #eef2f9 0%, #dce4f2 100%); background-attachment: fixed; background-size: cover; }
}

body { 
    margin: 0; padding: 0; min-height: 100svh; width: 100%;
    font-family: 'Space Grotesk', sans-serif; color: var(--text-main); 
    overflow-x: hidden; 
    overscroll-behavior-y: none;
}

body.locked {
    position: fixed;
    width: 100%;
    height: 100%;
    overflow: hidden;
    left: 0;
}

.page { 
    max-width: var(--page-max); width: 100%; margin: 0 auto; box-sizing: border-box;
    padding-top: calc(70px + env(safe-area-inset-top));
    padding-bottom: calc(80px + env(safe-area-inset-bottom));
    padding-left: 16px; padding-right: 16px;
}

/* Nav */
.sticky-container {
    position: fixed; top: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: var(--page-max); z-index: var(--z-nav);
    padding: 10px 16px 0 16px; 
    padding-top: calc(10px + env(safe-area-inset-top));
    pointer-events: none;
    box-sizing: border-box; 
}

.glass-bar {
    pointer-events: auto; display: flex; justify-content: space-between; align-items: center; 
    background: rgba(255,255,255,0.65); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    padding: 6px 6px 6px 16px; border-radius: 100px; border: 1px solid var(--border-subtle);
    box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    width: 100%; box-sizing: border-box; 
}

@media (prefers-color-scheme: dark) {
    .glass-bar { background: rgba(28, 28, 30, 0.7); border-color: rgba(255,255,255,0.1); }
}
h1 { font-size: 14px; font-weight: 800; text-transform: uppercase; margin: 0; color: var(--accent); letter-spacing: 0.5px; margin-right: auto; }

.view-switcher { display: flex; background: rgba(120, 120, 128, 0.12); padding: 3px; border-radius: 100px; gap: 2px; }
.view-btn { 
    border: none; background: transparent; padding: 8px 14px; 
    font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 100px; color: var(--text-muted); transition: 0.3s;
}
.view-btn.active { background: var(--bg-card); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

.btn-icon {
    width: 32px; height: 32px; border-radius: 50%; border: none; background: transparent; 
    display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--accent);
    margin-right: 8px;
}
.btn-icon:active { background: rgba(128,128,128,0.1); }
.btn-icon svg { width: 18px; height: 18px; fill: currentColor; }

/* Nav Buttons */
.month-nav { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; margin-bottom: 20px; }
.nav-btn { background: transparent; border: none; font-size: 20px; cursor: pointer; color: var(--accent); opacity: 0.7; padding: 5px 15px; }
.btn-today {
    background: rgba(128,128,128,0.1); border: none; padding: 6px 12px; border-radius: 20px;
    font-size: 11px; font-weight: 700; color: var(--text-muted); cursor: pointer;
    text-transform: uppercase; font-family: 'JetBrains Mono', monospace; transition: 0.2s;
}
.btn-today:active { background: var(--accent); color: #fff; }
#currentMonthDisplay { font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 800; text-transform: uppercase; color: var(--text-main); }

/* Stats Block */
.stats-overview { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
.stat-card-mini {
    background: var(--bg-card); padding: 15px; border-radius: var(--radius-m);
    box-shadow: var(--shadow-card); border: 1px solid var(--border-subtle);
    display: flex; flex-direction: column; justify-content: space-between;
}
.stat-card-mini.full-width { grid-column: span 2; flex-direction: row; align-items: center; gap: 15px; }
.stat-split { flex: 1; display: flex; flex-direction: column; }
.stat-split:last-child { align-items: flex-end; text-align: right; border-left: 1px solid var(--border-subtle); padding-left: 15px; }

.scm-label { font-size: 10px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
.scm-value { font-size: 14px; font-weight: 700; color: var(--text-main); font-family: 'JetBrains Mono', monospace; }
.scm-sub { font-size: 10px; margin-top: 4px; font-weight: 600; color: var(--text-muted); }

/* STATUS CARD */
.status-card { 
    background: var(--bg-card); border: 2px solid var(--accent); border-radius: var(--radius-l); 
    padding: 24px; margin-bottom: 30px; box-shadow: var(--shadow-card);
    display: flex; flex-direction: column; align-items: center; text-align: center;
}
.status-card.good { border-color: var(--color-on); }
.status-card.bad { border-color: var(--color-off); }

.status-header-text { 
    font-size: 11px; font-weight: 800; text-transform: uppercase; 
    letter-spacing: 1px; color: var(--text-muted); margin-bottom: 5px; 
}
.status-main-row {
    display: flex; align-items: center; justify-content: center; gap: 12px;
    margin: 5px 0 10px 0;
}
.status-icon-big svg { width: 36px; height: 36px; fill: currentColor; }
.status-time { 
    font-size: 56px; font-weight: 700; line-height: 1; 
    font-variant-numeric: tabular-nums; letter-spacing: -2px; 
}
.status-label { font-size: 11px; opacity: 0.6; font-family: 'JetBrains Mono', monospace; color: var(--text-main); margin-top: 0px; }

/* Week Header */
.week-header {
    margin: 25px 0 10px 0;
    padding: 0 5px;
    font-size: 11px; font-weight: 800; color: var(--text-muted); 
    text-transform: uppercase; letter-spacing: 1px;
    display: flex; align-items: center; gap: 10px;
}
.week-header::after { content: ''; flex: 1; height: 1px; background: var(--border-subtle); }

/* Day Container */
.day-container { 
    background: var(--bg-card); border-radius: var(--radius-m); padding: 18px; margin-bottom: 12px; 
    border: 1px solid var(--border-subtle); box-shadow: var(--shadow-card); transition: 0.2s;
    cursor: pointer; position: relative; overflow: hidden;
    scroll-margin-top: 150px; 
}
.day-container:active { transform: scale(0.99); }
.day-container.today { border: 2px solid var(--accent); }
.day-container.expanded { border-color: var(--accent); z-index: 10; }

.day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.day-date { font-size: 18px; font-weight: 700; color: var(--accent); }
.day-name { font-size: 13px; color: var(--text-muted); font-weight: 600; display: flex; align-items: center; gap: 6px; }
.chevron { font-size: 10px; transition: transform 0.3s; opacity: 0.5; }
.expanded .chevron { transform: rotate(180deg); opacity: 1; color: var(--accent); }
.today-badge { font-size: 10px; font-weight: 800; background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 10px; text-transform: uppercase; margin-left: 8px; }

.attack-badge {
    margin-top: 5px; font-size: 11px; font-weight: 700; color: var(--attack-text); 
    background: var(--attack-bg); padding: 6px 10px; border-radius: 8px; display: inline-flex; align-items: center; gap: 6px;
    border-left: 3px solid var(--attack-text); margin-bottom: 10px;
}
.attack-badge svg { fill: var(--attack-text) !important; }

/* Timeline Structure */
.timeline-block { display: flex; flex-direction: column; gap: 3px; margin-bottom: 12px; }
.timeline-track { position: relative; height: 24px; border-radius: 6px; overflow: hidden; background: var(--color-future); display: flex; }
.segment { pointer-events: auto; height: 100%; position: relative; }
.segment.future { 
    pointer-events: none; 
    background-image: repeating-linear-gradient(
        -45deg,
        transparent,
        transparent 4px,
        rgba(128,128,128,0.1) 4px,
        rgba(128,128,128,0.1) 8px
    );
}
.on { background: var(--color-on); }
.off { background: var(--color-off); }

.schedule-track { position: relative; height: 6px; border-radius: 3px; overflow: hidden; background: transparent; width: 100%; }
.sched-seg { position: absolute; top: 0; bottom: 0; cursor: help; }
.sched-green { background: var(--sched-safe); opacity: 0.5; } 
.sched-red { background: var(--sched-danger); opacity: 0.8; }
.now-marker { position: absolute; top: -2px; bottom: -2px; width: 2px; background: var(--accent); z-index: 5; box-shadow: 0 0 6px var(--accent); pointer-events: none; }

/* Stats Grid */
.day-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-subtle); }
.stat-box { display: flex; flex-direction: column; background: var(--border-subtle); border-radius: 10px; padding: 10px 12px; }
.stat-label { font-size: 10px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
.stat-value { font-size: 13px; color: var(--text-main); font-weight: 700; font-family: 'JetBrains Mono', monospace; }

.day-details { max-height: 0; opacity: 0; overflow: hidden; transition: 0.4s ease; }
.expanded .day-details { max-height: 500px; opacity: 1; margin-top: 15px; padding-top: 5px; border-top: 1px dashed var(--border-subtle); }
.detail-row { display: flex; justify-content: space-between; padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #fff; font-weight: 600; }

/* --- DRAWERS --- */
.drawer {
    position: fixed; top: 0; width: 100%; height: 100%;
    max-width: var(--page-max);
    background-color: var(--bg-body);
    z-index: var(--z-drawer);
    overflow-y: auto; 
    box-sizing: border-box;
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    will-change: transform;
    padding: 0 20px 40px 20px;
    left: 50%;
    transform: translateX(-50%);
}

.drawer-right { right: auto; left: 50%; transform: translateX(100vw); margin-left: -500px; }

@media (max-width: 1000px) {
    .drawer-right { left: 0; margin-left: 0; transform: translateX(100%); }
    .drawer-left { left: 0; margin-left: 0; transform: translateX(-100%); }
}
@media (min-width: 1001px) {
    .drawer-right { left: 50%; margin-left: -500px; transform: translateX(1000px); }
    .drawer-left { left: 50%; margin-left: -500px; transform: translateX(-1000px); }
}

.drawer-right.open { transform: translateX(0) !important; margin-left: 0; left: 0; width: 100%; } 
@media (min-width: 1001px) {
    .drawer-right.open { left: 50%; margin-left: -500px; transform: translateX(0) !important; }
}

.drawer-left.open { transform: translateX(0) !important; margin-left: 0; left: 0; width: 100%; }
@media (min-width: 1001px) {
    .drawer-left.open { left: 50%; margin-left: -500px; transform: translateX(0) !important; }
}

/* --- CALENDAR FIXED LAYOUT --- */
#calendarGrid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: clamp(4px, 1.5vw, 12px);
    margin-top: 10px;
    margin-left: auto;
    margin-right: auto;
    width: 100%;
    max-width: 480px; 
    box-sizing: border-box;
}

@media (orientation: landscape) and (max-height: 500px) {
    #calendarGrid { max-width: 60vh; }
}

@media (min-width: 768px) {
    #calendarGrid { max-width: 600px; }
}

.cal-weekday { 
    text-align: center; font-size: 10px; font-weight: 800; 
    color: var(--text-muted); margin-bottom: 5px; align-self: end; 
}

.cal-day { 
    aspect-ratio: 1; position: relative; cursor: pointer; display: flex; 
    align-items: center; justify-content: center; background: transparent; 
    border-radius: 50%; border: none; box-shadow: none; width: 100%; 
}
.cal-day:active { transform: scale(0.9); }
.ring-container { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; transform: translate(-50%, -50%) rotate(-90deg); pointer-events: none; z-index: 1; }
.cal-day.empty { background: transparent; cursor: default; }
.cal-inner { 
    width: 76%; height: 76%; background: var(--bg-card); border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; 
    font-size: clamp(10px, 2.5vw, 14px); font-weight: 700; color: var(--text-main); 
    z-index: 2; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
}
.cal-today .cal-inner { color: var(--accent); font-weight: 800; background: var(--bg-card); }
.cal-today { box-shadow: 0 0 0 2px var(--accent); }
.cal-attack-dot { position: absolute; top: 0; right: 0; z-index: 3; width: 14px; height: 14px; background: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.cal-day.empty-data .cal-inner { opacity: 0.5; box-shadow: none; }

/* ANALYTICS */
.chart-container {
    background: var(--bg-card); border-radius: var(--radius-m); padding: 20px;
    margin-bottom: 20px; box-shadow: var(--shadow-card); border: 1px solid var(--border-subtle);
}
.chart-header { font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; }

.timeline-24h { 
    height: 40px; width: 100%; background: var(--color-future); 
    border-radius: 8px; position: relative; overflow: hidden; display: flex;
}
.t24-seg { height: 100%; }
.t24-markers { display: flex; justify-content: space-between; margin-top: 6px; padding: 0 2px; }
.t24-mark { font-size: 10px; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); }

.bar-chart { display: flex; align-items: flex-end; justify-content: space-between; height: 120px; gap: 10px; padding-top: 10px; }
.bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; }
.bar-track { width: 100%; background: var(--border-subtle); border-radius: 6px 6px 0 0; flex: 1; position: relative; display: flex; align-items: flex-end; overflow: hidden; }
.bar-fill { 
    width: 100%; background: var(--accent); border-radius: 4px 4px 0 0; 
    min-height: 4px; transition: height 0.5s ease; opacity: 0.9; 
}
.bar-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-align: center; line-height: 1.1; }
.bar-val { font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700; color: var(--text-main); margin-bottom: 2px; }

#tooltip { 
    position: absolute; background: var(--tooltip-bg); color: var(--tooltip-text); 
    border: 1px solid rgba(255,255,255,0.1); padding: 8px 12px; 
    font-family: 'JetBrains Mono', monospace; font-size: 11px; 
    border-radius: 8px; pointer-events: none; opacity: 0; z-index: var(--z-tooltip); 
    box-shadow: 0 5px 20px rgba(0,0,0,0.3); white-space: nowrap; transition: opacity 0.2s;
    display: flex; align-items: center; gap: 8px;
}
#tooltip.visible { opacity: 1; }
#tooltip svg { width: 14px; height: 14px; fill: currentColor; }

footer { margin-top: 40px; text-align: center; font-size: 10px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
</style>
</head>
<body>

<div class="page">
    <div id="tooltip"></div>
    <div class="sticky-container">
        <div class="glass-bar">
            <button class="btn-icon" onclick="switchView('analytics')">
                <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
            </button>
            <h1>Моніторинг</h1>
            <div class="view-switcher">
                <button id="btn-list" class="view-btn active" onclick="switchView('list')">СПИСОК</button>
                <button id="btn-calendar" class="view-btn" onclick="switchView('calendar')">КАЛЕНДАР</button>
                <button class="btn-today" onclick="goToToday()">СЬОГОДНІ</button>
            </div>
        </div>
    </div>

    <div id="listView">
        <div id="statsOverview" class="stats-overview"></div>

        <div id="statusCard" class="status-card">
            <div id="statusText" class="status-header-text">ЗАВАНТАЖЕННЯ...</div>
            <div class="status-main-row">
                <div id="statusIcon" class="status-icon-big"></div>
                <div id="statusTimer" class="status-time">--:--</div>
            </div>
            <div id="statusLabel" class="status-label"></div>
        </div>
        
        <div id="daysListContainer"></div>
        <footer id="footerStats"></footer>
    </div>

    <div id="calendarDrawer" class="drawer drawer-right">
        <div style="height: 80px;"></div>
        <div class="month-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">←</button>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                <div id="currentMonthDisplay">...</div>
            </div>
            <button class="nav-btn" onclick="changeMonth(1)">→</button>
        </div>
        <div id="calendarView"></div>
        <div style="margin-top: 40px; text-align: center; font-size: 10px; color: var(--text-muted);">
            Календар відключень
        </div>
    </div>

    <div id="analyticsDrawer" class="drawer drawer-left">
        <div style="height: 90px;"></div>
        
        <div class="chart-container">
            <div class="chart-header">REAL FEEL (ОСТАННІ 7 ДНІВ)</div>
            <div id="vikaStats" style="display: flex; gap: 15px; align-items: center;"></div>
        </div>

        <div class="chart-container">
            <div class="chart-header">ЦИКЛ СВІТЛА (HEATMAP)</div>
            <div style="font-size:10px; color:var(--text-muted); margin-bottom:10px">Ймовірність наявності світла в конкретну годину:</div>
            <div id="heatmap" style="display: flex; align-items: flex-end; height: 60px; gap: 2px; padding-top:10px;"></div>
            <div style="display:flex; justify-content: space-between; font-size:9px; color:var(--text-muted); margin-top:4px; font-family:'JetBrains Mono'">
                <span>00</span><span>06</span><span>12</span><span>18</span><span>23</span>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">СТРУКТУРА ВКЛЮЧЕНЬ</div>
            <div style="font-size:11px; color:var(--text-muted); margin-bottom:10px;">Розподіл за тривалістю (короткі / середні / довгі):</div>
            <div id="stabilityChart" class="bar-chart"></div>
        </div>
    </div>
</div>

<script>
    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://jribfnztzwekgmjtykbs.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_Pf6YtRbiRx-l0gMOgTjcFQ_ngMm4QB1';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allEvents = [];
    let attacks = [];
    let schedule = {}; 
    let lastKnownEvent = null;
    let tipTimeout = null;
    let isLiveTimerRunning = false;
    let currentView = 'list'; 
    let scrollPosition = 0; 
    let viewDate = getKyivDate();
    viewDate.setHours(0,0,0,0);

    const blastSvg = `<svg style="width:14px;height:14px;vertical-align:middle;" viewBox="0 0 24 24"><path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z" /></svg>`;
    const warnSvg = `<svg style="width:10px;height:10px;fill:var(--color-off);" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
    const iconClock = `<svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>`;
    const iconBolt = `<svg viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`;

    function getKyivDate() { return new Date(); }

    async function init() {
        try {
            const { data: eventsData, error: eventsError } = await supabase
                .from('events')
                .select('*')
                .order('event_time', { ascending: true });
            
            if (eventsError) throw eventsError;

            allEvents = eventsData.map(e => {
                const d = new Date(e.event_time);
                const rawTime = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                return { date: d, type: e.type, raw: rawTime };
            });

            const { data: attacksData } = await supabase.from('attacks').select('*');
            if (attacksData) {
                attacks = attacksData.map(a => {
                    const d = new Date(a.start_time);
                    const dateKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    const timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    return { date: dateKey, time: timeStr, duration: a.duration_hours, desc: a.description };
                });
            }

            const { data: schedData } = await supabase.from('schedule').select('*');
            schedule = {}; 
            if (schedData) {
                schedData.forEach(item => {
                    addScheduleSegment(schedule, new Date(item.start_time), new Date(item.end_time), item.type);
                });
            }

            updateStatus(allEvents);
            render();
            renderAnalytics(allEvents);
        } catch (e) { 
            console.error("Supabase Error:", e);
            document.getElementById('statusText').innerText = "НЕМАЄ ДАНИХ";
            document.getElementById('daysListContainer').innerHTML = '<div style="text-align:center; padding:50px; opacity:0.5;">База даних порожня або недоступна.<br>Додайте події через Supabase.</div>';
        }
    }

    function addScheduleSegment(db, start, end, type) {
        let current = new Date(start);
        while (current < end) {
            let nextMidnight = new Date(current); 
            nextMidnight.setHours(24, 0, 0, 0);
            let segEnd = new Date(Math.min(end, nextMidnight));
            
            let y = current.getFullYear();
            let m = String(current.getMonth()+1).padStart(2,'0');
            let d = String(current.getDate()).padStart(2,'0');
            let dateKey = `${y}-${m}-${d}`;
            
            let sTime = `${String(current.getHours()).padStart(2,'0')}:${String(current.getMinutes()).padStart(2,'0')}`;
            let eTime = (segEnd.getTime() === nextMidnight.getTime()) ? "24:00" : 
                        `${String(segEnd.getHours()).padStart(2,'0')}:${String(segEnd.getMinutes()).padStart(2,'0')}`;
            
            if (!db[dateKey]) db[dateKey] = [];
            const exists = db[dateKey].some(s => s.start === sTime && s.end === eTime);
            if (!exists) { db[dateKey].push({ start: sTime, end: eTime, type: type }); }
            current = nextMidnight;
        }
    }

    function getWeightedDuration(startMs, endMs) {
        let weight = 0;
        let currentH = new Date(startMs);
        currentH.setMinutes(0,0,0);
        while(currentH.getTime() < endMs) {
            const h = currentH.getHours();
            const nextHTime = currentH.getTime() + 3600000;
            const segStart = Math.max(startMs, currentH.getTime());
            const segEnd = Math.min(endMs, nextHTime);
            if (segEnd > segStart) {
                const dur = (segEnd - segStart) / 60000;
                const w = (h >= 8 && h < 23) ? 1.0 : 0.3;
                weight += dur * w;
            }
            currentH.setTime(nextHTime);
        }
        return weight;
    }

    startLiveTimer();
    init();

    let lastDayCheck = new Date().getDate();
    setInterval(() => {
        const now = getKyivDate();
        if (now.getDate() !== lastDayCheck) {
            lastDayCheck = now.getDate();
            viewDate = getKyivDate(); viewDate.setHours(0,0,0,0);
            init();
        }
    }, 60000);

    function startLiveTimer() {
        if (isLiveTimerRunning) return;
        isLiveTimerRunning = true;
        setInterval(() => {
            if (lastKnownEvent) {
                const now = getKyivDate();
                const diffMs = now - lastKnownEvent.date;
                const diffMins = Math.max(0, Math.floor(diffMs / 60000));
                const timerEl = document.getElementById('statusTimer');
                if (timerEl) timerEl.innerText = formatDur(diffMins);
            }
            const markers = document.querySelectorAll('.now-marker');
            if (markers.length > 0) {
                const now = getKyivDate();
                const minsToday = now.getHours() * 60 + now.getMinutes();
                markers.forEach(m => m.style.left = (minsToday / 14.4) + '%');
            }
        }, 1000);
    }

    function generateDays(events) {
        if (!events.length) return [];
        const days = {};
        const now = getKyivDate();
        let pointerDate = new Date(events[0].date);
        pointerDate.setHours(0,0,0,0);
        let currentState = events[0].type === 'OFF' ? 'ON' : 'OFF'; 
        let eventIdx = 0;
        const endLimit = new Date(); endLimit.setHours(23,59,59);
        let firstLogTime = events[0].date.getTime();

        while (pointerDate <= endLimit) {
            const y = pointerDate.getFullYear();
            const m = String(pointerDate.getMonth()+1).padStart(2,'0');
            const dStr = String(pointerDate.getDate()).padStart(2,'0');
            const k = `${y}-${m}-${dStr}`;
            const dStart = new Date(pointerDate);
            const dEnd = new Date(pointerDate); dEnd.setHours(23,59,59);
            const attackData = attacks.find(a => a.date === k);
            const daySchedule = schedule[k] || [];

            days[k] = { 
                date: dStart, segments: [], scheduleSegments: [],
                totalOn: 0, totalOff: 0, 
                effectiveMinutes: 0, potentialWeight: 0, 
                vikaIndex: 0, stabilityFactor: 0,
                attack: attackData, hasData: false, outageCount: 0, maxOn: 0,
                matchMinutes: 0, schedMinutesTotal: 0
            };

            if (daySchedule.length) {
                daySchedule.forEach(slot => {
                     const [sh, sm] = slot.start.split(':').map(Number);
                     const [eh, em] = slot.end.split(':').map(Number);
                     let ehFix = (slot.end === "24:00") ? 24 : eh;
                     const startMins = sh*60 + sm;
                     const endMins = ehFix*60 + em;
                     const width = (endMins - startMins) / 14.4;
                     const left = startMins / 14.4;
                     days[k].scheduleSegments.push({ left, width, type: slot.type, startStr: slot.start, endStr: slot.end });
                });
            }

            let pTime = dStart.getTime();
            let potentialStart = (dStart.getTime() < firstLogTime) ? firstLogTime : dStart.getTime();
            let potentialEnd = (dStart.toDateString() === now.toDateString()) ? now.getTime() : dEnd.getTime();
            
            if (dEnd.getTime() >= events[0].date.getTime()) {
                days[k].hasData = true;
                days[k].potentialWeight = getWeightedDuration(potentialStart, potentialEnd);

                while (eventIdx < events.length && events[eventIdx].date <= dEnd) {
                    const ev = events[eventIdx];
                    if (currentState === 'ON' && ev.type === 'OFF' && ev.date.getTime() >= dStart.getTime()) {
                        days[k].outageCount++;
                    }
                    if (ev.date.getTime() > pTime) {
                        addSeg(days[k], pTime, ev.date.getTime(), currentState, now);
                    }
                    currentState = ev.type;
                    pTime = ev.date.getTime();
                    eventIdx++;
                }
                const isToday = dStart.toDateString() === now.toDateString();
                if (isToday) {
                    if (now.getTime() > pTime) addSeg(days[k], pTime, now.getTime(), currentState, now);
                    addSeg(days[k], now.getTime(), dEnd.getTime(), 'FUTURE', now);
                } else {
                    addSeg(days[k], pTime, dEnd.getTime(), currentState, now);
                }

                let baseQuality = (days[k].potentialWeight > 0) ? (days[k].effectiveMinutes / days[k].potentialWeight) : 0;
                let stabilityFactor = (days[k].totalOn > 0) ? (days[k].maxOn / days[k].totalOn) : 0;
                days[k].stabilityFactor = stabilityFactor;
                let fragmentPenalty = Math.min(days[k].outageCount * 0.04, 0.35);
                days[k].vikaIndex = baseQuality * (0.6 + 0.4 * stabilityFactor) * (1 - fragmentPenalty);

                if (daySchedule.length > 0) {
                    const TOLERANCE_MINS = 30; 
                    days[k].segments.forEach(seg => {
                        if (seg.type === 'FUTURE') return;
                        const [h1, m1] = seg.range.split(' - ')[0].split(':').map(Number);
                        const [h2, m2] = seg.range.split(' - ')[1].split(':').map(Number);
                        const sMin = h1*60 + m1;
                        const eMin = (h2*60 + m2) || 1440; 
                        
                        for (let m = sMin; m < eMin; m++) {
                            days[k].schedMinutesTotal++;
                            let isSchedOff = false;
                            for (let slot of daySchedule) {
                                const [sh, sm] = slot.start.split(':').map(Number);
                                const [eh, em] = slot.end.split(':').map(Number);
                                const slotS = sh*60 + sm;
                                const slotE = (eh === 0 && em === 0) ? 1440 : (eh*60 + em);
                                if (m >= slotS && m < slotE && slot.type === 'black') { isSchedOff = true; break; }
                            }
                            const actualOff = (seg.type === 'OFF');
                            if (isSchedOff && actualOff) days[k].matchMinutes++;
                            else if (isSchedOff && !actualOff) days[k].matchMinutes++;
                            else if (!isSchedOff && !actualOff) days[k].matchMinutes++;
                            else if (!isSchedOff && actualOff) {
                                let nearestDiff = 9999;
                                for (let slot of daySchedule) {
                                    if (slot.type !== 'black') continue;
                                    const [sh, sm] = slot.start.split(':').map(Number);
                                    const [eh, em] = slot.end.split(':').map(Number);
                                    const slotS = sh*60 + sm;
                                    const slotE = (eh === 0 && em === 0) ? 1440 : (eh*60 + em);
                                    const diffS = Math.abs(m - slotS);
                                    const diffE = Math.abs(m - slotE);
                                    nearestDiff = Math.min(nearestDiff, diffS, diffE);
                                }
                                if (nearestDiff <= TOLERANCE_MINS) days[k].matchMinutes++;
                            }
                        }
                    });
                }
            }
            pointerDate.setDate(pointerDate.getDate() + 1);
        }
        return Object.values(days).reverse();
    }

    function addSeg(day, start, end, type, now) {
        const diffMs = end - start;
        const mins = Math.floor(diffMs / 60000);
        if (mins <= 0) return;
        const isCurrent = (Math.abs(end - now.getTime()) < 60000) && type !== 'FUTURE';
        let statusText = '';
        if (type === 'ON') statusText = isCurrent ? 'СВІТЛО Є' : 'СВІТЛО БУЛО';
        else if (type === 'OFF') statusText = isCurrent ? 'СВІТЛА НЕМАЄ' : 'СВІТЛА НЕ БУЛО';
        else statusText = 'МАЙБУТНЄ';

        if (type === 'ON') { 
            day.totalOn += mins; 
            if (mins > day.maxOn) day.maxOn = mins; 
            day.effectiveMinutes += getWeightedDuration(start, end);
        }
        if (type === 'OFF') { day.totalOff += mins; } 

        day.segments.push({
            type, width: mins / 14.4,
            range: `${new Date(start).getHours()}:${String(new Date(start).getMinutes()).padStart(2,'0')} - ${new Date(end).getHours()}:${String(new Date(end).getMinutes()).padStart(2,'0')}`,
            dur: formatDur(mins),
            status: statusText
        });
    }

    function render() {
        const months = ["СІЧЕНЬ", "ЛЮТИЙ", "БЕРЕЗЕНЬ", "КВІТЕНЬ", "ТРАВЕНЬ", "ЧЕРВЕНЬ", "ЛИПЕНЬ", "СЕРПЕНЬ", "ВЕРЕСЕНЬ", "ЖОВТЕНЬ", "ЛИСТОПАД", "ГРУДЕНЬ"];
        document.getElementById('currentMonthDisplay').innerText = `${months[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
        
        const allDays = generateDays(allEvents);
        renderStatsOverview(allDays);
        
        const daysInMonth = allDays.filter(d => d.date.getMonth() === viewDate.getMonth() && d.date.getFullYear() === viewDate.getFullYear());
        renderList(daysInMonth);
        renderCalendar(daysInMonth);
        
        const updateTime = getKyivDate();
        document.getElementById('footerStats').innerText = `Оновлено: ${updateTime.toLocaleDateString()} ${updateTime.toLocaleTimeString()}`;
    }

    function renderAnalytics(events) {
        const days = generateDays(events);
        const validDays = days.filter(d => d.hasData).slice(0, 7);
        
        let avgVikaIndex = 0;
        let totalW = 0;
        validDays.forEach(d => {
            const w = 1.0; 
            avgVikaIndex += d.vikaIndex * w;
            totalW += w;
        });
        const finalScore = totalW > 0 ? (avgVikaIndex / totalW) * 100 : 0;
        
        let scoreColor = 'var(--color-neutral)';
        if(finalScore > 50) scoreColor = 'var(--color-on)';
        if(finalScore < 30) scoreColor = 'var(--color-off)';
        
        document.getElementById('vikaStats').innerHTML = `
            <div>
                <div style="font-size:36px; font-weight:800; color:${scoreColor}">${finalScore.toFixed(0)}%</div>
                <div style="font-size:10px; color:var(--text-muted); font-weight:700">ЯКІСТЬ ЖИТТЯ</div>
            </div>
            <div style="height:30px; width:1px; background:var(--border-subtle)"></div>
            <div style="flex:1">
                 <div style="font-size:10px; margin-bottom:4px; color:var(--text-muted)">ОЦІНКА ВРАХОВУЄ:</div>
                 <div style="display:flex; flex-wrap:wrap; gap:4px">
                    <span style="font-size:9px; background:var(--bg-body); padding:3px 6px; border-radius:4px;">Фрагментацію</span>
                    <span style="font-size:9px; background:var(--bg-body); padding:3px 6px; border-radius:4px;">Час доби</span>
                    <span style="font-size:9px; background:var(--bg-body); padding:3px 6px; border-radius:4px;">Стабільність</span>
                 </div>
            </div>
        `;

        renderHeatmap(days);

        const buckets = { short: 0, medium: 0, long: 0 };
        validDays.forEach(d => {
            d.segments.forEach(s => {
                if(s.type === 'ON') {
                    const mins = Math.round(s.width * 14.4);
                    if (mins < 60) buckets.short++;
                    else if (mins < 240) buckets.medium++;
                    else buckets.long++;
                }
            });
        });
        
        const maxVal = Math.max(buckets.short, buckets.medium, buckets.long, 1);
        const getH = (val) => (val / maxVal) * 100;
        
        document.getElementById('stabilityChart').innerHTML = `
            <div class="bar-col">
                <div class="bar-track"><div class="bar-fill" style="height:${getH(buckets.short)}%; background:var(--color-off)"></div></div>
                <div class="bar-val">${buckets.short}</div>
                <div class="bar-label">Короткі<br>< 1г</div>
            </div>
            <div class="bar-col">
                <div class="bar-track"><div class="bar-fill" style="height:${getH(buckets.medium)}%; background:var(--accent)"></div></div>
                <div class="bar-val">${buckets.medium}</div>
                <div class="bar-label">Середні<br>1-4г</div>
            </div>
            <div class="bar-col">
                <div class="bar-track"><div class="bar-fill" style="height:${getH(buckets.long)}%; background:var(--color-on)"></div></div>
                <div class="bar-val">${buckets.long}</div>
                <div class="bar-label">Довгі<br>> 4г</div>
            </div>
        `;
    }

    function renderHeatmap(days) {
        const validDays = days.filter(d => d.hasData).slice(0, 7);
        if (!validDays.length) return;

        const hourlyCounts = new Array(24).fill(0);
        const totalDays = validDays.length;

        validDays.forEach(day => {
            day.segments.forEach(seg => {
                if (seg.type !== 'ON') return;
                const parts = seg.range.split(' - ');
                if (parts.length !== 2) return;
                const [startH, startM] = parts[0].split(':').map(Number);
                const [endH, endM] = parts[1].split(':').map(Number);

                let sMin = startH * 60 + startM;
                let eMin = endH * 60 + endM;
                if (eMin < sMin) eMin = 1440; 

                for (let m = sMin; m < eMin; m++) {
                    const h = Math.floor(m / 60);
                    if (h >= 0 && h < 24) hourlyCounts[h]++; 
                }
            });
        });

        const container = document.getElementById('heatmap');
        if (!container) return;

        let html = '';
        for (let h = 0; h < 24; h++) {
            const totalPossibleMinutes = 60 * totalDays;
            const actualMinutes = hourlyCounts[h];
            const ratio = totalPossibleMinutes > 0 ? (actualMinutes / totalPossibleMinutes) : 0;
            const pct = Math.round(ratio * 100);
            
            let bg = 'var(--color-future)';
            if (ratio > 0) bg = `rgba(37, 78, 219, ${0.2 + ratio * 0.8})`; 
            
            html += `<div style="flex:1; background:${bg}; height:${Math.max(4, pct)}%; border-radius:2px; position:relative;" onclick="showTip(event, '${h}:00 - ${h+1}:00', 'Ймовірність: ${pct}%', 'Середнє за 7 днів', true)"></div>`;
        }
        container.innerHTML = html;
    }

    function renderStatsOverview(days) {
        const now = getKyivDate();
        const completedDays = days.filter(d => d.hasData && d.date.toDateString() !== now.toDateString() && d.segments.every(s => s.type !== 'FUTURE'));
        if (completedDays.length < 2) { 
            document.getElementById('statsOverview').innerHTML = ''; return; 
        }
        const maxComparisonDays = 7;
        const availablePairs = Math.floor(completedDays.length / 2);
        const daysToCompare = Math.min(availablePairs, maxComparisonDays);
        const currentPeriod = completedDays.slice(0, daysToCompare);
        const prevPeriod = completedDays.slice(daysToCompare, daysToCompare * 2);
        
        const calcWeightedAvg = (periodDays) => {
            let totalWeightedScore = 0; let totalWeight = 0;
            periodDays.forEach(d => {
                let simpleIndex = (d.potentialWeight > 0) ? (d.effectiveMinutes / d.potentialWeight) : 0;
                totalWeightedScore += simpleIndex * d.potentialWeight;
                totalWeight += d.potentialWeight;
            });
            return totalWeight > 0 ? (totalWeightedScore / totalWeight) : 0;
        };
        const wAvgNow = calcWeightedAvg(currentPeriod);
        const wAvgPrev = calcWeightedAvg(prevPeriod);
        let trend = wAvgPrev ? ((wAvgNow - wAvgPrev) / wAvgPrev) * 100 : 0;
        let trendIcon = '→'; let trendClass = 'trend-neutral'; let trendText = 'СТАБІЛЬНО';
        if (Math.abs(trend) >= 5) {
            trendIcon = trend > 0 ? '↗' : '↘'; 
            trendClass = trend > 0 ? 'trend-up' : 'trend-down';
            trendText = trend > 0 ? 'КРАЩЕ' : 'ГІРШЕ';
        }
        const daysWithSched = days.filter(d => d.hasData && d.schedMinutesTotal > 0).slice(0, 7);
        let accuracy = 0;
        if(daysWithSched.length > 0) {
            let matchSum = 0; let totalSum = 0;
            daysWithSched.forEach(d => { matchSum += d.matchMinutes; totalSum += d.schedMinutesTotal; });
            accuracy = totalSum > 0 ? (matchSum / totalSum * 100) : 0;
        }
        document.getElementById('statsOverview').innerHTML = `
            <div class="stat-card-mini full-width">
                <div class="stat-split">
                    <div class="scm-label">ДИНАМІКА (7 ДНІВ)</div>
                    <div class="scm-value ${trendClass}">${trendText} ${Math.abs(trend) < 5 ? '' : Math.abs(trend).toFixed(1) + '%'} ${trendIcon}</div>
                    <div class="scm-sub">обсяг світла</div>
                </div>
                <div class="stat-split">
                    <div class="scm-label">ТОЧНІСТЬ ГРАФІКА</div>
                    <div class="scm-value" style="color:${accuracy > 80 ? 'var(--color-on)' : 'var(--color-off)'}">${accuracy.toFixed(0)}%</div>
                    <div class="scm-sub">допуск 30 хв (smart)</div>
                </div>
            </div>
            ${renderBestWorst(days)}
        `;
    }
    
    function renderBestWorst(days) {
        const monthDays = days.filter(d => d.date.getMonth() === viewDate.getMonth());
        const best = monthDays.reduce((p,c) => (c.totalOn > (p?.totalOn||0)) ? c : p, null);
        const worst = monthDays.reduce((p,c) => (c.totalOff > (p?.totalOff||0) && c.hasData) ? c : p, null);
        if (!best && !worst) return '';
        return `
            ${best ? `<div class="stat-card-mini"><div class="scm-label">НАЙКРАЩИЙ</div><div class="scm-value" style="color:var(--color-on)">${formatDur(best.totalOn)}</div><div class="scm-sub">${best.date.getDate()}.${String(best.date.getMonth()+1).padStart(2,'0')}</div></div>` : ''}
            ${worst ? `<div class="stat-card-mini"><div class="scm-label">НАЙГІРШИЙ</div><div class="scm-value" style="color:var(--color-off)">${formatDur(worst.totalOff)}</div><div class="scm-sub">${worst.date.getDate()}.${String(worst.date.getMonth()+1).padStart(2,'0')}</div></div>` : ''}
        `;
    }

    function renderList(days) {
        let html = '';
        const now = getKyivDate();
        const names = ["Неділя", "Понеділок", "Вівторок", "Середа", "Четвер", "П'ятниця", "Субота"];
        let lastWeekLabel = null;
        days.forEach((day, idx) => {
            if (!day.hasData) return;
            const d = new Date(day.date);
            const dayNum = d.getDay() || 7; 
            d.setHours(0,0,0,0);
            d.setDate(d.getDate() - dayNum + 1);
            const wStart = d;
            const wEnd = new Date(d); wEnd.setDate(wEnd.getDate() + 6);
            let weekLabel = '';
            const currentD = getKyivDate();
            const currentDayNum = currentD.getDay() || 7;
            const currentMon = new Date(currentD); currentMon.setHours(0,0,0,0);
            currentMon.setDate(currentMon.getDate() - currentDayNum + 1);
            if (wStart.getTime() === currentMon.getTime()) weekLabel = "ПОТОЧНИЙ ТИЖДЕНЬ";
            else weekLabel = `ТИЖДЕНЬ ${String(wStart.getDate()).padStart(2,'0')}.${String(wStart.getMonth()+1).padStart(2,'0')} – ${String(wEnd.getDate()).padStart(2,'0')}.${String(wEnd.getMonth()+1).padStart(2,'0')}`;
            if (weekLabel !== lastWeekLabel) {
                html += `<div class="week-header">${weekLabel}</div>`; lastWeekLabel = weekLabel;
            }
            const isToday = day.date.toDateString() === now.toDateString();
            const dayId = `day-${day.date.getDate()}`;
            let schedHtml = '';
            day.scheduleSegments.forEach(s => {
                const cls = s.type === 'black' ? 'sched-red' : 'sched-green'; 
                const label = s.type === 'black' ? 'ГРАФІК: ВІДКЛЮЧЕННЯ' : 'ГРАФІК: МОЖЛИВЕ СВІТЛО';
                const desc = s.type === 'black' ? 'Заплановано або екстрено' : 'Світло має бути (сіра зона)';
                schedHtml += `<div class="sched-seg ${cls}" style="left:${s.left}%; width:${s.width}%;" onclick="showTip(event, '${label}', '${s.startStr} - ${s.endStr}', '${desc}', true)"></div>`;
            });
            let segs = '', dets = '<div class="day-details">';
            if (isToday) {
                const minsToday = now.getHours() * 60 + now.getMinutes();
                segs += `<div class="now-marker" style="left:${minsToday/14.4}%"></div>`;
            }
            day.segments.forEach(s => {
                const isFut = s.type === 'FUTURE';
                segs += `<div class="segment ${s.type.toLowerCase()} ${isFut ? 'future' : ''}" style="width:${s.width}%" ${isFut ? '' : `onclick="showTip(event,'${s.status}','${s.range}','${s.dur}', false)"`}></div>`;
                if (!isFut) dets += `<div class="detail-row" style="background:${s.type.toUpperCase() === 'ON' ? 'var(--color-row-on)' : 'var(--color-row-off)'}"><span>${s.range}</span><span>${s.dur}</span></div>`;
            });
            let attackHtml = '';
            if (day.attack) attackHtml = `<div class="attack-badge">${blastSvg} <span>${day.attack.desc} (${day.attack.duration}г)</span></div>`;
            dets += '</div>';
            const total = 1440; const pct = Math.round((day.totalOn / total) * 100);

            html += `<div id="${dayId}" class="day-container ${isToday?'today':''}" onclick="toggleDay(this)">
                <div class="day-header">
                    <div style="display:flex; align-items:center;">
                        <span class="day-date">${day.date.getDate()}.${String(day.date.getMonth()+1).padStart(2,'0')}</span>
                        ${isToday ? '<span class="today-badge">СЬОГОДНІ</span>' : ''}
                    </div>
                    <div class="day-name">${names[day.date.getDay()]} <span class="chevron">▼</span></div>
                </div>
                ${attackHtml}
                <div class="timeline-block">
                    <div class="timeline-track">${segs}</div>
                    <div class="schedule-track">${schedHtml}</div>
                </div>
                <div class="day-stats-grid">
                    <div class="stat-box"><div class="stat-label">СВІТЛО БУЛО</div><div class="stat-value" style="color:var(--color-on)">${formatDur(day.totalOn)} (${pct}%)</div></div>
                    <div class="stat-box"><div class="stat-label">СВІТЛА НЕМАЄ</div><div class="stat-value" style="color:var(--color-off)">${formatDur(day.totalOff)}</div></div>
                    <div class="stat-box"><div class="stat-label">ВІДКЛЮЧЕНЬ</div><div class="stat-value">${day.outageCount}</div></div>
                    <div class="stat-box"><div class="stat-label">МАКС. СВІТЛО</div><div class="stat-value">${formatDur(day.maxOn)}</div></div>
                </div>
                ${dets}</div>`;
        });
        document.getElementById('daysListContainer').innerHTML = html || '<div style="text-align:center; padding:50px; opacity:0.3;">Немає даних</div>';
    }

    function renderCalendar(days) {
        const first = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
        const last = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0);
        let offset = first.getDay(); if (offset === 0) offset = 7; offset--;
        
        let html = '<div id="calendarGrid">';
        ["ПН","ВТ","СР","ЧТ","ПТ","СБ","НД"].forEach(d => html += `<div class="cal-weekday">${d}</div>`);
        
        for (let i = 0; i < offset; i++) html += '<div class="cal-day empty"></div>';
        const dayMap = {}; days.forEach(d => dayMap[d.date.getDate()] = d);
        const now = getKyivDate();
        const trackPath = 'd="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"';

        for (let i = 1; i <= last.getDate(); i++) {
            const data = dayMap[i];
            if (!data || !data.hasData) {
                html += `
                <div class="cal-day empty-data">
                    <svg class="ring-container" viewBox="0 0 36 36"><path ${trackPath} fill="none" stroke="var(--border-subtle)" stroke-width="4" opacity="0.3" /></svg>
                    <div class="cal-inner">${i}</div>
                </div>`;
                continue;
            }
            const isToday = (now.getDate() === i && now.getMonth() === viewDate.getMonth() && now.getFullYear() === viewDate.getFullYear());
            const total = 1440; 
            let pctOn = (data.totalOn / total) * 100;
            let pctOff = (data.totalOff / total) * 100;
            if (pctOn + pctOff > 100) {
                const scale = 100 / (pctOn + pctOff);
                pctOn *= scale;
                pctOff *= scale;
            }
            const c = 100; 
            const dashOn = `${pctOn} ${c}`;
            const dashOff = `${pctOff} ${c}`;
            const offsetOff = -pctOn; 
            const svg = `
            <svg class="ring-container" viewBox="0 0 36 36">
                <path ${trackPath} fill="none" stroke="var(--border-subtle)" stroke-width="4" opacity="0.5" />
                <path ${trackPath} fill="none" stroke="var(--color-on)" stroke-width="4" stroke-dasharray="${dashOn}" stroke-dashoffset="0" stroke-linecap="round" />
                <path ${trackPath} fill="none" stroke="var(--color-off)" stroke-width="4" stroke-dasharray="${dashOff}" stroke-dashoffset="${offsetOff}" stroke-linecap="round" />
            </svg>
            `;
            let dot = ''; 
            if (data.attack) dot = `<div class="cal-attack-dot">${warnSvg}</div>`;
            const todayClass = isToday ? 'cal-today' : '';
            html += `<div class="cal-day ${todayClass}" onclick="goToDay(${i})">${svg}<div class="cal-inner">${i}</div>${dot}</div>`;
        }
        document.getElementById('calendarView').innerHTML = html + '</div>';
    }

    // --- NAV & UI LOGIC ---
    function lockScroll() {
        scrollPosition = window.scrollY;
        document.body.style.top = `-${scrollPosition}px`;
        document.body.classList.add('locked');
    }

    function unlockScroll() {
        document.body.classList.remove('locked');
        document.body.style.top = '';
        window.scrollTo(0, scrollPosition);
    }

    function switchView(viewName) {
        const calDrawer = document.getElementById('calendarDrawer');
        const anaDrawer = document.getElementById('analyticsDrawer');
        currentView = viewName;
        calDrawer.classList.remove('open');
        anaDrawer.classList.remove('open');
        calDrawer.style.transform = '';
        anaDrawer.style.transform = '';

        if (viewName === 'calendar') { lockScroll(); calDrawer.classList.add('open'); }
        else if (viewName === 'analytics') { lockScroll(); anaDrawer.classList.add('open'); }
        else { unlockScroll(); }

        document.getElementById('btn-list').classList.toggle('active', currentView === 'list');
        document.getElementById('btn-calendar').classList.toggle('active', currentView === 'calendar');
    }

    let startX = 0, startY = 0;
    let isTracking = false;
    let isDirectionLocked = false;
    let activeDrawer = null; 
    const EDGE_THRESHOLD = 40; 

    document.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        startX = touch.clientX; startY = touch.clientY;
        isTracking = false; isDirectionLocked = false; activeDrawer = null;
        
        const screenW = window.innerWidth;
        const calDrawer = document.getElementById('calendarDrawer');
        const anaDrawer = document.getElementById('analyticsDrawer');

        if (currentView === 'list') {
            if (startX > screenW - EDGE_THRESHOLD) { activeDrawer = calDrawer; isTracking = true; activeDrawer.style.transition = 'none'; }
            else if (startX < EDGE_THRESHOLD) { activeDrawer = anaDrawer; isTracking = true; activeDrawer.style.transition = 'none'; }
        } else if (currentView === 'calendar') { activeDrawer = calDrawer; isTracking = true; activeDrawer.style.transition = 'none'; }
        else if (currentView === 'analytics') { activeDrawer = anaDrawer; isTracking = true; activeDrawer.style.transition = 'none'; }
    }, {passive: false});

    document.addEventListener('touchmove', (e) => {
        if (!isTracking || !activeDrawer) return;
        const touch = e.touches[0];
        const diffX = touch.clientX - startX;
        const diffY = touch.clientY - startY;

        if (!isDirectionLocked) {
            if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 5) { isTracking = false; return; }
            if (Math.abs(diffX) > 5) isDirectionLocked = true;
        }
        if (isDirectionLocked) e.preventDefault();
        const screenW = window.innerWidth;
        
        if (activeDrawer.id === 'calendarDrawer') {
            if (currentView === 'list') {
                const p = Math.max(0, 100 + (diffX / screenW * 100));
                activeDrawer.style.transform = `translateX(${p}%)`;
            } else {
                const p = Math.max(0, (diffX / screenW * 100));
                activeDrawer.style.transform = `translateX(${p}%)`;
            }
        } else {
            if (currentView === 'list') {
                const p = Math.min(0, -100 + (diffX / screenW * 100));
                activeDrawer.style.transform = `translateX(${p}%)`;
            } else {
                const p = Math.min(0, (diffX / screenW * 100));
                activeDrawer.style.transform = `translateX(${p}%)`;
            }
        }
    }, {passive: false});

    document.addEventListener('touchend', (e) => {
        if (!isTracking || !activeDrawer) return;
        isTracking = false;
        activeDrawer.style.transition = 'transform 0.35s cubic-bezier(0.32, 0.72, 0, 1)';
        const diff = e.changedTouches[0].clientX - startX;
        const screenW = window.innerWidth; const threshold = screenW * 0.25;

        if (activeDrawer.id === 'calendarDrawer') {
            if (currentView === 'list') {
                if (diff < -threshold) switchView('calendar');
                else { activeDrawer.style.transform = ''; if (!activeDrawer.classList.contains('open')) unlockScroll(); }
            } else { if (diff > threshold) switchView('list'); else activeDrawer.style.transform = ''; }
        } else {
            if (currentView === 'list') {
                if (diff > threshold) switchView('analytics');
                else { activeDrawer.style.transform = ''; if (!activeDrawer.classList.contains('open')) unlockScroll(); }
            } else { if (diff < -threshold) switchView('list'); else activeDrawer.style.transform = ''; }
        }
    });

    const calGrid = document.getElementById('calendarView');
    let calStartX = 0;
    if (calGrid) {
        calGrid.addEventListener('touchstart', (e) => { calStartX = e.touches[0].clientX; }, {passive: true});
        calGrid.addEventListener('touchend', (e) => {
            const diff = e.changedTouches[0].clientX - calStartX;
            if (Math.abs(diff) > 50) { e.stopPropagation(); changeMonth(diff > 0 ? -1 : 1); }
        });
    }

    function changeMonth(delta) { viewDate.setMonth(viewDate.getMonth() + delta); render(); }
    
    function goToToday() {
        viewDate = getKyivDate(); viewDate.setHours(0,0,0,0);
        switchView('list'); render();
        setTimeout(() => {
            const todayEl = document.querySelector('.day-container.today');
            if (todayEl) { todayEl.scrollIntoView({behavior: 'smooth', block: 'center'}); if(!todayEl.classList.contains('expanded')) toggleDay(todayEl); }
        }, 300); 
    }

    function toggleDay(element) {
        const isAlreadyOpen = element.classList.contains('expanded');
        document.querySelectorAll('.day-container.expanded').forEach(el => el.classList.remove('expanded'));
        if (!isAlreadyOpen) { element.classList.add('expanded'); setTimeout(() => { element.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300); }
    }

    function goToDay(dayNum) {
        const el = document.getElementById(`day-${dayNum}`);
        if (el) { switchView('list'); setTimeout(() => { el.scrollIntoView({behavior: 'smooth', block: 'center'}); toggleDay(el); }, 300); }
    }

    function updateStatus(events) {
        if (!events.length) return;
        const now = getKyivDate(); const last = events[events.length - 1]; lastKnownEvent = last;
        const diff = Math.max(0, Math.floor((now - last.date) / 60000));
        
        const card = document.getElementById('statusCard'); 
        const icon = document.getElementById('statusIcon');
        const text = document.getElementById('statusText');
        const timer = document.getElementById('statusTimer');
        
        if (last.type === 'ON') { 
            card.className = 'status-card good'; icon.innerHTML = iconBolt; text.innerText = 'СВІТЛО Є';
            timer.style.color = 'var(--color-on)'; icon.style.color = 'var(--color-on)';
        } else { 
            card.className = 'status-card bad'; icon.innerHTML = iconBolt; text.innerText = 'СВІТЛА НЕМАЄ';
            timer.style.color = 'var(--color-off)'; icon.style.color = 'var(--color-off)';
        }
        timer.innerText = formatDur(diff); 
        document.getElementById('statusLabel').innerText = `ЗМІНА: ${last.date.toLocaleDateString()} ${last.raw}`;
    }

    function formatDur(m) { return m < 60 ? `${m}хв` : `${Math.floor(m/60)}г ${m%60}хв`; }

    function showTip(e, s, r, d, isSchedule) {
        e.stopPropagation();
        if (tipTimeout) clearTimeout(tipTimeout);
        const tip = document.getElementById('tooltip');
        const icon = isSchedule ? iconClock : iconBolt;
        tip.innerHTML = `${icon} <div><strong>${s}</strong><br><span style="opacity:0.8">${r}</span><br><span style="font-size:10px; opacity:0.6">${d}</span></div>`;
        tip.classList.add('visible');
        
        const screenWidth = window.innerWidth; const x = e.pageX; const y = e.pageY;
        if (x > screenWidth / 2) { tip.style.left = 'auto'; tip.style.right = (screenWidth - x + 10) + 'px'; tip.style.transform = 'translate(0, -100%)'; }
        else { tip.style.left = (x + 10) + 'px'; tip.style.right = 'auto'; tip.style.transform = 'translate(0, -100%)'; }
        tip.style.top = (y - 15) + 'px';
        if (e.type !== 'mouseover') { tipTimeout = setTimeout(() => { tip.classList.remove('visible'); }, 2500); }
    }
    
    document.addEventListener('click', () => { document.getElementById('tooltip').classList.remove('visible'); if (tipTimeout) clearTimeout(tipTimeout); });
    document.body.addEventListener('mouseout', function(e) { if (e.target.closest('.sched-seg') || e.target.closest('.segment')) document.getElementById('tooltip').classList.remove('visible'); });
    document.body.addEventListener('mouseover', function(e) {
        const target = e.target.closest('.sched-seg') || e.target.closest('.segment');
        if (target && !target.classList.contains('future')) {
            const onClickAttr = target.getAttribute('onclick');
            if (onClickAttr) {
                const parts = onClickAttr.match(/'([^']+)'/g); 
                const isBool = onClickAttr.includes('true');
                if (parts && parts.length >= 3) {
                    showTip(e, parts[0].replace(/'/g, ''), parts[1].replace(/'/g, ''), parts[2].replace(/'/g, ''), isBool);
                }
            }
        }
    });
</script>
</body>
</html>
