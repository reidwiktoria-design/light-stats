<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Статистика Світла</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

<style>
:root {
    --bg-page: #eef0f2;
    --bg-card: #ffffff;
    --accent-dark: #1a1a1a;
    --accent-blue: #254EDB;
    --color-on: #8DAA91;   
    --color-off: #E07A5F;
    --color-row-on: #7E9C82; 
    --color-row-off: #CC6A50;
    --color-on-bg: #E8F5E9;
    --color-off-bg: #FFF3E0;
    --text-main: #111111;
    --text-muted: #888888;
}

body { font-family: 'Space Grotesk', sans-serif; background: var(--bg-page); margin: 0; padding: 20px 10px; color: var(--text-main); }
.page { max-width: 500px; margin: 0 auto; padding-bottom: 40px; }

header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 4px; }
h1 { font-size: 22px; font-weight: 800; text-transform: uppercase; letter-spacing: -0.5px; margin: 0; }
.sub { font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700; background: #fff; padding: 4px 8px; border-radius: 6px; border: 1px solid #ddd; color: var(--accent-blue); text-transform: uppercase; }

.status-card { background: #fff; border: 2px solid var(--accent-dark); border-radius: 16px; padding: 20px; margin-bottom: 35px; box-shadow: 4px 4px 0px var(--accent-dark); display: flex; flex-direction: column; align-items: center; text-align: center; transition: all 0.3s; }
.status-card.good { background: var(--color-on-bg); border-color: var(--color-on); box-shadow: 4px 4px 0px var(--color-on); }
.status-card.bad { background: var(--color-off-bg); border-color: var(--color-off); box-shadow: 4px 4px 0px var(--color-off); }
.status-icon { font-size: 13px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-family: 'JetBrains Mono', monospace; }
.status-time { font-size: 42px; font-weight: 700; line-height: 1; margin-bottom: 10px; font-variant-numeric: tabular-nums; }
.status-label { font-size: 11px; opacity: 0.7; font-family: 'JetBrains Mono', monospace; }

.day-container { 
    background: var(--bg-card); 
    border-radius: 12px; 
    padding: 16px 14px; 
    margin-bottom: 12px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.02); 
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer; 
    overflow: hidden;
    position: relative;
    border: 2px solid transparent; 
}
.day-container:active { transform: scale(0.99); }
.day-container.today { border-color: rgba(37, 78, 219, 0.2); background: linear-gradient(to bottom right, #ffffff, #f8faff); }
.day-container.expanded { border-color: var(--accent-blue); box-shadow: 0 10px 30px rgba(37, 78, 219, 0.15); z-index: 10; }
.day-container.perfect { border-color: var(--color-on); }

.day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 0 2px; }
.day-date-group { display: flex; align-items: center; gap: 10px; }
.day-date { font-size: 17px; font-weight: 700; color: var(--accent-blue); }
.day-name { font-size: 14px; color: var(--text-muted); font-weight: 500; }
.today-badge { font-size: 10px; font-weight: 800; background: var(--accent-blue); color: #fff; padding: 3px 6px; border-radius: 4px; text-transform: uppercase; line-height: 1; }

.timeline { height: 24px; display: flex; border-radius: 6px; overflow: hidden; background: #eef0f2; margin-bottom: 4px; position: relative; }
.segment { height: 100%; position: relative; cursor: pointer; transition: all 0.2s ease; }
.segment:hover { filter: brightness(1.1); transform: scaleY(1.05); z-index: 2; }
.on { background: var(--color-on); }
.off { background: var(--color-off); }
.future { background: repeating-linear-gradient(45deg, #e0e0e0, #e0e0e0 4px, #f2f2f2 4px, #f2f2f2 8px); opacity: 0.4; cursor: default; pointer-events: none; }
.now-marker { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--accent-blue); z-index: 20; pointer-events: none; }

.scale { display: flex; justify-content: space-between; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #aaa; margin-bottom: 12px; padding: 0 2px; }
.day-summary { display: flex; justify-content: space-between; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-main); padding-top: 8px; border-top: 1px solid #f0f0f0; }
.sum-item { display: flex; align-items: baseline; gap: 6px; }
.label-on { color: var(--color-on); font-weight: 800; font-size: 10px; text-transform: uppercase; }
.label-off { color: var(--color-off); font-weight: 800; font-size: 10px; text-transform: uppercase; }
.day-summary b { color: var(--text-main); font-size: 12px; font-weight: 700; }

.day-details {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease, margin-top 0.4s ease;
}
.day-container.expanded .day-details { max-height: 600px; opacity: 1; margin-top: 15px; padding-top: 5px; }
.detail-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 6px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #fff; font-weight: 500; }
.row-on { background: var(--color-row-on); }
.row-off { background: var(--color-row-off); }

.chevron { font-size: 10px; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #ccc; margin-left: 6px; display: inline-block; }
.day-container.expanded .chevron { transform: rotate(180deg); color: var(--accent-blue); }

.week-separator { display: flex; align-items: center; color: var(--text-muted); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 30px 0 15px; opacity: 0.5; }
.week-separator::before, .week-separator::after { content: ''; flex: 1; height: 1px; background: #ccc; }
.week-separator span { padding: 0 10px; }

#tooltip { position: absolute; background: var(--accent-dark); color: #fff; padding: 5px 8px; font-family: 'JetBrains Mono', monospace; font-size: 10px; border-radius: 4px; pointer-events: none; opacity: 0; z-index: 100; white-space: nowrap; }
#tooltip.visible { opacity: 1; }
footer { margin-top: 40px; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #aaa; }
</style>
</head>
<body>

<div class="page">
    <div id="tooltip"></div>
    <header>
        <h1>МОНІТОРИНГ СВІТЛА</h1>
        <div class="sub" id="currentMonth">...</div>
    </header>
    <div id="statusCard" class="status-card">
        <div class="status-icon" id="statusIcon">Завантаження...</div>
        <div class="status-time" id="statusTimer">00:00</div>
        <div class="status-label" id="statusLabel">...</div>
    </div>
    <div id="daysWrapper"></div>
    <footer id="footerStats"></footer>
</div>

<script>
    // ФУНКЦІЯ ЗАВАНТАЖЕННЯ ЗОВНІШНЬОГО ФАЙЛУ
    async function loadLogs() {
        try {
            // Додаємо timestamp, щоб GitHub не кешував старий файл
            const response = await fetch('logs.txt?t=' + Date.now());
            const text = await response.text();
            render(text);
        } catch (error) {
            document.getElementById('statusIcon').innerText = "Помилка завантаження logs.txt";
            console.error(error);
        }
    }

    function parseLogs(rawText) {
        const lines = rawText.split('\n');
        const events = [];
        lines.forEach(line => {
            const isTurnedOn = line.toLowerCase().includes('увімкнули') || line.toLowerCase().includes('світло є');
            const isTurnedOff = line.toLowerCase().includes('зникло') || line.toLowerCase().includes('немає');
            if (!isTurnedOn && !isTurnedOff) return;
            const dateMatch = line.match(/(\d{2}\.\d{2}\.\d{2,4})/);
            const timeMatch = line.match(/(\d{2}:\d{2})/);
            if (dateMatch && timeMatch) {
                let dateStr = dateMatch[1];
                let timeStr = timeMatch[1];
                const dParts = dateStr.split('.');
                let year = dParts[2].length === 2 ? '20' + dParts[2] : dParts[2];
                events.push({
                    date: new Date(`${year}-${dParts[1]}-${dParts[0]}T${timeStr}:00`),
                    type: isTurnedOn ? 'ON' : 'OFF',
                    rawTime: timeStr
                });
            }
        });
        return events.sort((a, b) => a.date - b.date);
    }

    function generateDays(events) {
        if (events.length === 0) return [];
        const days = {}; 
        const now = new Date(); 
        let currentDate = new Date(events[0].date);
        currentDate.setHours(0,0,0,0);
        let currentState = events[0].type === 'OFF' ? 'ON' : 'OFF';
        let eventIndex = 0;
        
        const endLoopDate = new Date();
        endLoopDate.setHours(23,59,59,999);

        while (currentDate <= endLoopDate) {
            const dayKey = currentDate.toISOString().split('T')[0];
            const dayStart = new Date(currentDate);
            const dayEnd = new Date(currentDate); dayEnd.setHours(23,59,59,999);
            days[dayKey] = { date: new Date(dayStart), segments: [], totalOn: 0, totalOff: 0 };
            let pointer = dayStart.getTime();

            while (eventIndex < events.length) {
                const ev = events[eventIndex];
                if (ev.date >= dayEnd) break; 
                if (ev.date.getTime() > pointer) {
                    addSegment(days[dayKey], pointer, ev.date.getTime(), currentState);
                }
                currentState = ev.type;
                pointer = ev.date.getTime();
                eventIndex++;
            }

            if (dayStart.toDateString() === now.toDateString()) {
                if (now.getTime() > pointer) {
                    addSegment(days[dayKey], pointer, now.getTime(), currentState, currentState === 'ON' ? 'СВІТЛО Є' : 'СВІТЛА НЕМАЄ');
                    pointer = now.getTime();
                }
                addSegment(days[dayKey], pointer, dayEnd.getTime(), 'FUTURE');
            } else {
                addSegment(days[dayKey], pointer, dayEnd.getTime(), currentState);
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return Object.values(days);
    }

    function addSegment(dayObj, startMs, endMs, type, customStatus = null) {
        if (startMs >= endMs) return;
        const diffMs = endMs - startMs;
        const minutes = Math.floor(diffMs / 60000);
        const startD = new Date(startMs);
        const endD = new Date(endMs);
        dayObj.segments.push({
            type, width: (minutes / 1440) * 100,
            range: formatTime(startD) + ' - ' + formatTime(endD),
            dur: formatDuration(minutes),
            percentStr: minutes > 0 ? `(${Math.round((minutes / 1440) * 100)}%)` : '',
            statusLabel: customStatus || (type === 'ON' ? 'БУЛО' : 'НЕ БУЛО')
        });
        if (type === 'ON') dayObj.totalOn += minutes;
        if (type === 'OFF') dayObj.totalOff += minutes;
    }

    function updateStatus(events) {
        if (!events.length) return;
        const now = new Date();
        const last = events[events.length - 1];
        const diffMins = Math.floor((now - last.date) / 60000);
        const card = document.getElementById('statusCard');
        card.className = last.type === 'ON' ? 'status-card good' : 'status-card bad';
        document.getElementById('statusIcon').innerText = last.type === 'ON' ? '● СВІТЛО Є' : '● СВІТЛА НЕМАЄ';
        document.getElementById('statusTimer').innerText = `${Math.floor(diffMins/60)}г ${diffMins%60}хв`;
        document.getElementById('statusLabel').innerText = `${last.type === 'ON' ? 'Увімкнули' : 'Зникло'}: ${last.date.toLocaleDateString('uk-UA')}, ${last.rawTime}`;
    }

    function toggleDay(element) {
        const isExp = element.classList.contains('expanded');
        document.querySelectorAll('.day-container').forEach(d => d.classList.remove('expanded'));
        if (!isExp) element.classList.add('expanded');
    }

    function render(rawText) {
        const events = parseLogs(rawText);
        let dayData = generateDays(events);
        dayData.reverse();
        const now = new Date();
        document.getElementById('currentMonth').innerText = `${["СІЧЕНЬ", "ЛЮТИЙ", "БЕРЕЗЕНЬ", "КВІТЕНЬ", "ТРАВЕНЬ", "ЧЕРВЕНЬ", "ЛИПЕНЬ", "СЕРПЕНЬ", "ВЕРЕСЕНЬ", "ЖОВТЕНЬ", "ЛИСТОПАД", "ГРУДЕНЬ"][now.getMonth()]} ${now.getFullYear()}`;
        updateStatus(events);

        let html = '';
        const dayNames = ["Неділя", "Понеділок", "Вівторок", "Середа", "Четвер", "П'ятниця", "Субота"];

        dayData.forEach((day, index) => {
            const isToday = day.date.toDateString() === now.toDateString();
            if (day.date.getDay() === 0 && index !== 0) html += '<div class="week-separator"><span>Минулий тиждень</span></div>';
            
            let segmentsHtml = '';
            let detailsHtml = '<div class="day-details">';
            if (isToday) segmentsHtml += `<div class="now-marker" style="left:${(now.getHours()*60+now.getMinutes())/14.4}%;"></div>`;

            day.segments.forEach(seg => {
                const isFut = seg.type === 'FUTURE';
                segmentsHtml += `<div class="segment ${seg.type.toLowerCase()}" style="width:${seg.width}%;" ${isFut ? '' : `data-status="${seg.statusLabel}" data-range="${seg.range}" data-dur="${seg.dur}"`}></div>`;
                if (!isFut) detailsHtml += `<div class="detail-row row-${seg.type.toLowerCase()}"><span>${seg.range}</span><span>${seg.dur} ${seg.percentStr}</span></div>`;
            });

            html += `
            <div class="day-container ${isToday ? 'today' : 'past'} ${day.totalOff === 0 ? 'perfect' : ''}" onclick="toggleDay(this)">
                <div class="day-header"><div class="day-date-group"><div class="day-date">${formatDDMM(day.date)}</div>${isToday ? '<span class="today-badge">СЬОГОДНІ</span>' : ''}</div><div class="day-name">${dayNames[day.date.getDay()]} <span class="chevron">▼</span></div></div>
                <div class="timeline">${segmentsHtml}</div>
                <div class="scale"><span>00:00</span><span>12:00</span><span>24:00</span></div>
                <div class="day-summary"><div class="sum-item"><span class="label-on">БУЛО:</span> <b>${day.totalOn ? formatShort(day.totalOn) : '-'}</b></div><div class="sum-item"><span class="label-off">НЕ БУЛО:</span> <b>${day.totalOff ? formatShort(day.totalOff) : '-'}</b></div></div>
                ${detailsHtml}</div></div>`;
        });
        document.getElementById('daysWrapper').innerHTML = html;
        document.getElementById('footerStats').innerText = `Оновлено: ${formatDDMM(now)} ${formatTime(now)}`;
        attachTooltips();
    }

    function formatTime(d) { return d.toLocaleTimeString('uk-UA', {hour: '2-digit', minute:'2-digit'}); }
    function formatDDMM(d) { return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`; }
    function formatDuration(m) { return m < 60 ? `${m}хв` : `${Math.floor(m/60)}г ${m%60}хв`; }
    function formatShort(m) { return m < 60 ? `${m}хв` : `${Math.floor(m/60)}г ${m%60}хв`; }

    function attachTooltips() {
        const tip = document.getElementById('tooltip');
        document.querySelectorAll('.segment').forEach(s => {
            if (s.classList.contains('future')) return;
            s.addEventListener('click', (e) => {
                e.stopPropagation();
                tip.innerHTML = `<strong>${s.dataset.status}</strong><br>${s.dataset.range}<br>${s.dataset.dur}`;
                const rect = s.getBoundingClientRect();
                tip.style.left = `${Math.max(60, Math.min(window.innerWidth-60, rect.left + rect.width/2))}px`;
                tip.style.top = `${rect.top - 45 + window.scrollY}px`;
                tip.style.transform = 'translate(-50%, 0)';
                tip.classList.add('visible');
            });
        });
    }
    document.addEventListener('click', () => document.getElementById('tooltip').classList.remove('visible'));

    // ЗАПУСК
    loadLogs();
</script>
</body>
</html>
